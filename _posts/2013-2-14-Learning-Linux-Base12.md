---
layout: post
title: 《鸟哥的Linux私房菜:基础篇》学习笔记——12.Linux账号管理与ACL权限设置
time: 2013-2-14
category: LinuxBase
published: false
---


#Linux的账号与用户组#

##用户标示符:UID与GID##

虽然我们登录Linux主机的时候，输入的是我们账号，但是其实Linux主机并不会直接认识你的"账号名称"的，它仅认识ID(一组号码)。ID与账号的对应关系就在`/etc/passwd`当中

每个登录的用户至少会取得两个ID，一个是用户ID(UserID,简称UID)，一个是用户组ID(GroupID,简称GID)

每一个文件都会有所谓的所有者ID与用户组ID，当我们有要显示文件属性的需求时，系统会依据`/etc/passwd`与`/etc/group`内容，找到UID/GID对应的账号名称再显示出来。

##用户账号##

用户登录的流程:
1. 先寻找`/etc/passwd`里面是否有你输入的账号，如果没有则跳出;如果有的话则将该账号对应的UID与GID(在`/etc/group`中)读出来，另外，该账号的主文件夹与shell设置也一并读出
2. 再来则是核对密码表，这是Linux会进入`/etc/shadow`里面找出对应的账号与UID，然后核对一下你刚才输入的密码与里面的密码是否相符。
3. 如果一切都OK的话，就进入shell控管的阶段了。

**从上面的情况可以看出，`/etc/passwd`和`/etc/shadow`这两个文件是非常重要的，如果要备份Linux系统的账号的话，这个两个文件是必须要备份的**

这两个文件的简单介绍:

**`/etc/passwd文件结构`**
这个文件构造是这样的:每一行都代表一个账号，有几行就代表有几个账号在你的系统中！不过需要特比留意的是，里面很多账号本来就是系统正常运行所必须要的，我们可以简称它为系统账号，例如bin,daemon,adm,nobody等，这些账号请不要随意删掉。
每一行信息都是使用":"分隔开，共有七个字段，分别是:

`root:x:0:0:root:/root:/bin/root`

|--------+-----+-----+-----+--------+---------+-------------|
|  1     |  2  |  3  |  4  |   5    |    6    |    7        |
|:------:|:---:|:---:|:---:|:------:|:-------:|:-----------:|
|  root  |  x  |  0  |  0  |  root  |  /root  |  /bin/root  |
|--------+-----+-----+-----+--------+---------+-------------|

1. 账号名称
		就是账号，用来对应UID的。
2. 密码
		原来这个字段是用来存放密码的，但是考虑到安全的问题，现在所有的密码都保存在`/etc/shadow`中，这里就只剩下一个x了
3. UID
		这个就是用户标识符。通常Linux对UID有几个限制。
		|-------------------------+--------------------------------------------------------------------------------------------------|
		|      id范围   	 				|  该ID用户特性  
		|:-----------------------:|:-------------------------------------------------------------------------------------------------|
		|  0(系统管理员)   				|  当UID是0时，代表这个账号是"系统管理员"！所以你要让其他账号名称也具有root权限时，将该账号的UID改为0即可。也就是说一个系统上面的系统管理员不见得只有root。不过，很不建议有多个账号的UID是0。 		                                   |
		|  1~499(系统账号) 				|  保留给系统使用的的ID，其实除了0之外，其他UID权限与特性并没有不一样。默认500以下的数字让给系统作为保留账号只是一个习惯.由于系统上面启动的服务希望使用较小的权限去运行，因此不希望使用root的身份去执行这些服务，所以我们就得要提供这些运行中程序的所有者账号才行。这些系统账号通常是不可登录的.\\格局系统账号的由来，通常系统账号又被分为两种:\\1~99:由distribution自行创建的系统账号;\\100~499:若用户有系统账号需求时，可以使用的账号UID                                                             |
		|  500~65535(可登陆账号)  |  给一般用户用的。                                                                                |
		|-------------------------+--------------------------------------------------------------------------------------------------|

4. GID
		这个与`/etc/group`有关！其实`/etc/group`与`/etc/passwd`差不多，只是它是用来规定组名与GID的对应而已
5. 用户信息说明列
		这个字段基本上没有什么重要用途，只是用来说明这个账号的意义而已。不过，如果你提供使用`finger`的功能时，这个字段可以提供很多的信息
6.主文件夹
		这是用户的主文件夹。默认是`/home/yourIDname`
7.Shell
		指定该账号所使用的bash，需要注意的是，有一个shell可以用来替代成让账号无法取得shell环境的登录操作,那就是`sbin/nologin`

**`/etc/shadow`**
很多程序的运行都与权限有关，而权限与UID/GID有关！因此各程序当然需要读取`/etc/passwd`来了解不同账号权限，因此`/etc/passwd`的权限需设置为`-rw-r--r--`，早起的密码也是放在`/etc/passwd`中的，但是这样很容易被有心人所窃取，所以后来把密码移动到`/etc/shadow`中，而且还加入很多的密码限制参数在`/etc/shadow`里面！	
基本上，shadow同样以":"作为分隔符，一共有9个字段，这9个字段的说明如下:
1. 账号名称
		密码也需要和账号对应，所以这个文件的第一列就是账号，必须要与`/etc/passwd`相同才行
2. 密码
		这个字段内的数据才是真正的密码，而且是经过加密的密码，在这里只会看到一些特殊符号的字母。
3. 最近更动密码的日期
		这个字段记录了改动密码的日期，日期的时间时以1970年1月1日作为1而累加的日期，1971年1月1日则为366.
4. 密码不可被更改的天数(与第三个字段相比)
		第四个字段记录了这个账号的密码在最近一次被更改之后需要经过几天才可以再被更改！如果是0的话，表示密码随时可以改动的意思。
5. 密码需要重新更改的天数(与第3个字段相比)
		经常更改密码是一个好习惯。为了强制用户更改密码，这个字段可以指定在最近一次更改密码后在多少天数内需要再次更改密码才行。你必须要在这个天数内重新设置你的密码，否则这个账号的密码将会变为过期特性。如果是99999(计算为273年)的话，那就表示密码的更改没有强制性之意
6. 密码需要更改期限前的警告天数(与第5个字段相比)
		当账号的密码有效期限快要到的时候(第5个字段)，系统会依据这个字段的设置发出"警告"给这个账号，提醒他再过n天你的密码就要过期了。
7. 密码过期后的账号宽限时间(密码失效日)(与第5个字段相比)
		密码有效日期为"更新日期"(第3个字段)+"重新更改日期"(第5个字段)，过了该期限之后用户依旧没有更新密码，那改密码就算过期了。虽然密码过期但是该账号还是可以用来进行其他工作的，包括登录系统取得bash。不过如果密码过期了，那当你登录系统时，系统会强制要求你必须重新设置密码才能登录继续使用，这就是密码过期的特性
		在密码过期几天后，如果用户还是没有登录更改密码，那么这个账号的密码将会"失效"，即该账号再也无法使用改密码登录了。要注意**密码过期**与**密码失效**并不相同
8. 账号失效日期
		这个日期跟第三个字段一样，都是使用1970年以来的总日数设置。这个字段表示:这个账号在此字段规定的日期之后，将无法再使用。就是所谓的"账号失效"。此时不论你的密码是否过期，这个"账号"都不能再被使用。这个字段会被使用通常应该是在"收费服务"的系统中，你可以规定一个日期让该账号不能再使用。
9. 保留
		最后一个字段是保留的，看以后有没有新功能加入

##有效与初始用户组##
和用户组有关的数据信息是保存在`/etc/group`和`/etc/gshadow`中的

**`/etc/group`**
这个文件就是记录GID与组名的对应。这个文件每一行代表一个用户组，也是以冒号":"作为字段的分隔符，共分为四列，每一个字段的意义是:

1. 用户组名称
		就是用户组名称
2. 用户组密码
		通常不需要设置，这个设置通常是给"用户组管理员"使用的，目前很少有这个机会设置用户组管理员。同样，密码已经移动`/etc/gshadow`去，因此这个字段只会存在一个"x"而已
3. GID
		就是用户组ID。在`/etc/passwd`第四个字段使用的GID对应的用户组名就是由这里对一个出来的。
4. 此用户组支持的账号名称
		某个账号想要加入此用户组时，将该账号填入这个字段即可。(注意不要有空格)

**有效用户组(effective group)与初始用户组(initial group)**
每个用户在他的`/etc/passwd`里面的第四列有所谓的GID，这个GID就是所谓的"初始用户组(`initial group`)",也就说，当用户登录系统，立刻就拥有这个用户组的相关权限，因此，每一个账号的初始用户组是不用写入到`/etc/group`中的
如果一个账号加入了多个组，那么这个账号新建的文件或目录的组的是什么？这就要检查一下当时的有效用户组了(effective group)

**groups:有效与支持用户组的查看**
		可以直接通过`groups`命令查看当前账号所支持的用户组。查询结果中的第一个用户组就是当前账号的有效用户组(effective group),通常来说，有效用户组的功能就是新建文件

**newgrp:有效用户组的切换**
可以通过`newgrp`命令来切换有效用户组，但是想要切换的用户组必须是你已经有支持的用户组

**`/etc/gshadow`**
这个文件内同样还是使用冒号":"来作为字段的分隔符，一共有四个字段，分别说明如下:
1. 用户组名
2. 密码列，同样，开头为!表示无合法密码，所以无用户组管理员
3. 用户组管理员的账号(相关信息在gpasswd中介绍)
4. 该用户组的所属的账号(与`/etc/group`内容相同)


#账号管理#

##新增与删除用户:useradd,相关配置文件,passwd,usermod,userdel##

账号可以使用`useradd`来新建账号，密码则是使用`passwd`来设置

系统其实已经帮我们规定好了很多的默认值，所以我们可以简单地使用`useradd username`来创建用户即可,CentOS这些默认值会帮我们处理以下几个项目:

1. 在`/etc/passwd`里面创建一行与账号相关的数据，包括创建UID/GID/主文件夹等
2. 在`/etc/shadow`里面将此账号的密码相关参数填入，但是尚未有密码
3. 在`/etc/group`李米娜加入一个与账号名称一模一样的组名
4. 在`/home`下面创建一个与账号同名的目录作为用户主文件夹，且权限为700

使用`useradd`创建用户账号时，其实会更改不少地方，有以下几个文件:

1. 用户账号与密码参数方面的文件:`/etc/passwd`,`/etc/shadow`
2. 用户组相关方面的文件:`/etc/group`,`/etc/gshadow`
3. 用户的主文件夹:`/home/username`

**useradd参考文件**
其实，`useradd`的默认值可以用`useradd -D`调出来，其中的默认值都是保存在`/etc/default/useradd`中，可以使用vim查看并修改其内容
该文件的内容如下:

{% highlight bash %}
GROUP=100							#默认的用户组
HOME=/home						#默认的主文件夹所在目录
INACTIVE=-1						#密码失效日，在shadow内的第7列  0代表立刻过期，-1代表永不过期
EXPIRE=								#账号失效日，在shadow内的第8列
SHELL=/bin/bash				#默认的shell
SKEL=/etc/skel				#用户主文件夹内容数据参考目录
CREATE_MAIL_SPOOL=yes #是否主动帮用户创建邮件信箱(mailbox)
{% endhighlight %}

其中有个字段需要特别说明:
- 关于用户组的角度有两种不同的机制，这两种机制分别是:
		- 私有用户组机制:系统会创建一个与账号一样的用户组给用户作为初始用户组，这种设置机制会比较有保密性，因为用户都有自己的用户组，而且主文件夹权限将设置为700。使用这种机制将不会参考`GROUP=100`这个设置。代表性的distribution有RHEL,Fedora,CentOS等
		- 公共用户组机制:就是以`GROUP=100`这个设置值作为新建账号的初始用户组，因此每个账号都属于users这个用户组，且默认主文件夹通常的权限会是`drwxr-xr-x`，由于每个账号都属于users用户组，因此大家都可以互相分享主文件夹内的数据。代表性的distribution如SuSE
- `SKEL=/etc/skel`:用户主文件夹参考基准目录。新建用户的主文件夹内的各项数据都是由`/etc/skel`复制过去的，可以在新建`/etc/skel/www`这个目录，那么将来新增用户后，在他的主文件夹下就会有www这个目录了


**`/etc/login.defs`**
该文件内容如下:

{% highlight bash %}
MALL_DIR /var/spool/mail				#用户默认邮件信箱放置目录
PASS_MAX_DAYS 99999 						#/etc/shadow内的第5列，多久需要更改密码
PASS_MIN_DAYS 0									#/etc/shadow内的第4列，多久不可重新设置密码天数
PASS_MIN_LEN	5									#密码最短的字符长度，已被pam模块替代，失去效用！
PASS_WARN_AGE 7									#/etc/shadow内的第6列，过期前会警告的天数

UID_MIN 500											#用户最小的UID，意即小于500的UID为系统保留
UID_MAX 6000										#用户能够用的最大UID
GID_MIN 500											#用户自定义用户组的最小GID，小于500为系统保留
GID_MAX 6000										#用户自定义用户组的最大GID	

CREATE_HOME	yes									#在不加-M及-m时，是否主动创建用户文件夹
UMASK	077												#用户主文件夹建的umask，因此权限会是700
USERGROUPS_ENAB yes							#使用userdel删除时，是否会删除初始用户组
MD5_CRYPT_ENAB yes							#密码是否经过MD5的加密机制处理
{% endhighlight %}

要注意的是，系统给予一个账号UID时，它是先参考UID_MIN设置值取得最小数值，由`/etc/passwd`查找最大的UID数值，将二者相比，找出最大的那个再加一就是新账号的UID了。
`USERROUPS_ENAB yes`这个值设置的功能是:如果使用userdel去删除一个账号时，且该账号所属的初始用户组已经没有隶属于该用户组了，那么就删除该用户组

使用`useradd`这个程序在创建Linux上的账号时至少会参考:

- `/etc/default/useradd`
- `/etc/login.defs`
- `/etc/skel/*`

**passwd**

使用`useradd`创建账号之后，在默认情况下，该账号是暂时被封锁的，也就是说，该账号是无法登陆的,需要root使用`passwd 账号`的方式来修改密码。需要注意的是，`passwd`不加任何参数时，是修改自己的密码

新的distribution是使用较严格的PAM模块来管理密码，这个管理的机制写在`/etc/pam.d/passwd`当中。该文件与密码有关的测试模块就是使用pam_cracklib.so,这个模块会检验密码相关的信息，并且替代`\etc\login.defs`内的PASS_MIN_LEN的设置，理论上，你的密码最好哟啊符合如下要求:

- 密码不能与账号相同
- 密码尽量不要选用字典里面会出现的字符串
- 密码需要超过8个字符
- 密码不要用个人信息、如身份证、手机号码、其他电话号码等
- 密码不要使用简单的关系式，如1+1=2,lamvbird等
- 密码尽量使用大小写字符、数字、特殊符号的组合

**chage**
这个命令可以更加详细的显示密码参数.这个命令可以可以让用户在第一次登录时强制他们一定要更改密码后才能够使用系统资源

**usermod**
可以对用户账号的相关数据进行微调

**userdel**
删除用户的数据，用户的数据有:

- 用户账号/密码相关参数:`/etc/passwd`,`/etc/shadow`		
- 用户组相关参数:`/etc/group`,`/etc/gshadow`
- 用户个人文件数据:`/home/username`,`/var/spool/mail/username`

语法十分简单:

{% highlight bash %}
userdel [-r] username
{% endhighlight %}
参数:
-r:连同用户的主文件也一起删除

##用户功能##

**chfn**
可以用来修改用户的个人信息

**chsh**
change shell的简写,可以列出系统上所有可用的shell，也可以修改自己的shell

**id**
可以查询某人或自己相关的UID/GID等的信息

##新增与删除用户组##

基本上用户组的内容都与这两个文件有关:`/etc/group`,`/etc/gshadow`

**groupadd**
新建用户组

**groupmod**
和`usermod`相似，这个命令仅是在进行group相关参数的修改而已

**groupdel**
删除用户组。这里需要注意的是，只有当这个用户组不是某个账户的初始用户组时，才能被删除

#主机的具体权限规划:ACL的使用#

ACL:Access Control List,主要的目的是提供传统的owner、group、others的read、write、execute权限之外的具体权限设置。ACL可以针对单一用户、单一文件或目录来进行r、w、x的权限设置，对于需要特殊权限的使用状况非常有帮助

ACL主要可以针对以下几个项目:
- 用户(user):可以针对用户来设置权限
- 用户组(group):可以对用户组来设置权限
- 默认属性(mask):还可以在该目录下载新建新文件/目录时设置新数据的默认权限

##ACL的设置技巧:getfacl,setfacl##

设置与查看ACL有以下两个命令:

`getfacl`:取得某个文件/目录的ACL设置项目
`setfacl`:设置某个目录/文件的ACL规定


#用户身份切换#

##su##

{% highlight bash %}
su						#使用non-login的方式变成root，不能拥有root的环境变量、信箱等
su -					#使用login shell的方式切换为root的身份并查看变量
{% endhighlight %}

**总结**
- 若要完整地切换到新用户的环境，必须要使用`su -username`或`su -l username`,才会连同`PATH/USER/MAIL`等变量都转成新用户的环境；
- 如果仅想要执行一次root的命令时，可以利用`su -- c"命令串"`的方式来处理
- 使用root切换成任何用户时，并不需要输入新用户的密码

##sudo##

相对于su需要了解新切换的用户密码，sudo的执行则仅需要自己的密码即可！并非所有人都能够执行sudo，**而是仅有`/etc/sudoers`内的用户才能够执行sudo这个命令。**

**sudo**的执行流程
1. 当用户执行sudo时，系统于`/etc/sudoers`文件中查找该用户是否有执行sudo的权限
2. 若用户具有可执行sudo的权限后，便让用户输入自己的密码来确认
3. 若密码输入成功，便开始进行sudo后续接的命令
4. 若欲切换的身份与执行者相同，那也不需要输入密码

能否用`sudo`必须要看`/etc/sudoer`的设置值，而可使用`sudo`的是通过输入用户自己的密码来执行后续的命令串

**`visudo`与`/etc/sudoers`**

root可以通过`visudo`命令修改`/etc/sudoers`中的内容，要注意的是`/etc/sudoers`中是有格式的，如果设置错误会引起不良后果的。

#用户的特殊Shell与PAM模块#

##特殊的shell,/sbin/nologin##

系统中有很多系统账号，所谓系统账号就是指那些不能通过shell登录的账号，他们使用的shell是`/sbin/nologin`.系统中的各个服务是由不同的系统账号进行管理的，但是这些账号却是不能通过shell登录的。如果要让具有`/sbin/nologin`的用户知道，他们不能登录主机时，我们可以新建`/etc/nologin.txt`这个文件，并且在这个文件内说明不能登录的原因，那么下次当这个用户想要登录系统时，屏幕上就会出现`/etc/nologin.txt`这个文件的内容，而不是默认的内容了

##PAM模块简介##

PAM:Pluggable Authentication Modules

PAM可以说是一套应用程序编程接口，它提供了一连串的验证机制，只要用户将验证阶段的需求告诉PAM后，PAM就能够回报用户验证的结果(成功或失败)
因为不论你使用什么程序，都可以使用PAM来进行验证，如此一来，就能够让账户密码或者其他方式的验证具有一致的结果，也让程序员方便处理验证的问题了。

##PAM模块的设置语法##

PAM通过一个与程序相同文件名的配置文件来进行一连串的认证分析，到执行`passwd`后，这个程序调用PAM的流程是:
1. 用户开始执行`/usr/bin/passwd`这支程序，并输入密码
2. passwd调用PAM模块进行验证
3. PAM模块会到`/etc/pam.d`中寻找与程序(passwd)同名的配置文件
4. 依据`/etc/pam.d/passwd`内的设置，引用相关的PAM模块逐步进行验证分析
5. 将验证结果(成功、失败以及其他信息)回传给passwd这个程序
6. passwd这支程序会根据PAM回传的结果决定下一个操作(重新输入密码或通过验证)

`/etc/pam.d/passwd`中的内容如下所示:

{% highlight bash %}
auth			include			system-auth
account		include			system-auth
passwd		include			system-auth
验证类型 控制标准    PAM模块与该模块的参数
{% endhighlight %}

在这个配置文件中，除了第一行声明PAM版本之外，其他任何"#"开头的都是批注，而每一行都是一个独立的验证流程，每一行可以区分三个字段，分别是类别(tpye)，控制标准(flag),PAM的模块与该模块的参数。

**第一个字段:验证类型(type)**
验证类型一共分为四种，分别说明如下:
- auth 
	是authentication的缩写，所以这种类型主要用来检验用户的身份验证，这种类型通常是需要密码来检验的，所有后续接的模块是用来检验用户的身份
- account
	account则大部分是在进行authentication，这种类型则主要在检验用户是否具有正确的权限，举例来说，当你使用一个过期的密码来登录时，当然就无法正确登录了
- session
	session管理的就是用户在这侧登录期间PAM所给予的环境设置，这个类型通常用于记录用户登录与注销时的信息
- passwd
	passwd就是密码。所以这种类别主要用于提供验证的修订工作，就是修改密码

**第二个字段:验证的控制标志(control flag)**
它是"验证通过的标准",这个字段在管控验证的放行方式，主要也分为四种控制方式:
- required
	此验证若成功则带有success的标志，若失败则带有failure的标志，但不论成功或失败都会继续后续的验证流程。由于后续的验证流程可以继续进行，因此相当有利于数据的登录日志(log)，这也是PAM最常用required的原因
- requisite
	若验证失败则立刻回报原程序failure的标志。并终止后续的验证流程。若验证成功则带有success的标志并继续后续的验证流程。
- sufficient
	若验证成功则立刻回传success给原程序，并终止后续的验证流程；若验证失败则带有failure标志并继续后续的验证流程，这与requisite刚好相反！
- optional
	这个模块控件的目的大多是在显示信息而已，并不是用在验证方面

##常用模块简介##

这部分内容比较琐碎且只是介绍一些模块的功能，所以决定跳过这部分内容。具体的详细内容见P437

#Linux主机上的用户信息传递#

##查询用户:w,who,last,lastlog##

如果想要知道目前已登录在系统上面的用户，可以通过`w`或`who`来查询
想知道每个账号的最近登录时间，则可以使用`lastlog`这个命令

##用户对谈:write,mesg,wall##

`write`这个命令可以直接将信息传给接收者，可以这样做：

{% highlight bash %}
write 用户账号 [用户所在终端接口]
{% endhighlight %}

如果不想接收信息，则可以使用如下命令:

{% highlight bash %}
mesg n  #禁止别人发来的信息，但是root发的必须接收 
mesg y  #开禁
{% endhighlight %}

如果想向所有的用户广播，则可以使用如下命令:

{% highlight bash %}
wall "I will shutdown my linux server..."
{% endhighlight %}

##用户邮件邮箱:mail##

一般来说，mailbox都会放置在`/var/spool/mail`里面，一个账号一个mailbox(文件)。

寄信的命令十分简单，直接执行`mail username@localhost -s`即可
收信的命令也十分简单，直接运行`mail`命令就行了

由于读过的信件若使用"q"离开时，会将该信件移动到`~/mbox`中，所以你也可以想象`/var/spool/mail/vbird1`为vbird1的"信箱",而`/home/vbird1/mbox`则为"收信箱"的意思。那如何读取`/home/vbird1/mbox`呢？就使用`mail -f /home/vbird/mbox`即可

#手动新增用户#

 一般来说，不建议使用手动的方式来新增用户。因为用户的新建涉及GID/UID等权限的关系，而且，与文件/目录的权限也有关系，使用`useradd`可以帮我们自动设置好UID/GID主文件夹以及主文件夹相关的权限设置，但是，手动增加时，有可能忘东忘西，结果导致一些困扰。

由于暂时不需要具体的手动新增用户，所以这部分内容暂且跳过，具体的内容在P443


