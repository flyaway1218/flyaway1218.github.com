---
layout: post
title: 《鸟哥的Linux私房菜:基础篇》学习笔记——17.认识与分析日志文件
time: 2013-2-14
category: LinuxBase
published: false
---


#什么是日志文件#

日志文件简单地说，就是**记录系统活动的几个文件，例如:何时、何地(来源IP)、何人(什么服务名称)、做了什么操作(信息日志)**换句话说，记录系统在什么时候由哪个进程做了什么样的行为时，发生了何种的事件等

**日志文件的重要性**
- 解决系统方面的错误
- 解决网络服务的问题
- 过往事件记录簿

**Linux常见的日志文件名**
日志文件的权限通常是设置为仅有root能够读取而已
- /var/log/cron
	例行性工作的日志文件
- /var/log/dmesg
	记录系统在开机的时候内核检测过程所产生的各项信息
- /var/log/lastlog
	记录系统上面所有的账号最近一次登录系统时的相关信息
- /var/log/mailog或/var/log/mail/*
	记录邮件往来的信息，其实主要是记录sendmail(SMTP协议提供者)与dovecot(POP3协议提供者)所产生的信息
- /var/log/messages
	这个文件相当重要，几乎系统发生的错误信息都会记录在这个文件中，如果系统发生莫名的错误时，这个文件一定要查阅的日志文件之一
- /var/log/secure
	基本上，只要牵涉到需要输入账号密码的软件，那么当登录时(不管登录正确或错误)都会被记录在此文件中
- /var/log/wtmp,/var/log/faillog
	这两个文件可以记录正确登录系统者的账户信息(wtmp)与错误登录时所使用的账户信息(faillog)
- /var/log/httpd/*,/var/log/news/*,/var/log/samba/*
	不同的网络服务会使它们自己的日志文件案来记载它们自己产生的各项信息

常见的日志文件就是这几个，但是不同的Linux distribution中，通常日志文件的文件名不会相同。对于不同的系统还需要查阅相关的日志文件设置数据才行

**日志文件所需相关服务(daemon)与进程**
日志文件的产生方式一般有两种:一种是有软件开发商自行定义写入的日志文件与相关格式，例如apache；另一种则是由Linux distribution提供的日志文件管理服务来统一管理，只要将信息丢给这个服务之后，它就会自己分门别类地将各种信息放置到相关日志文件去
CentOS提供syslog这个服务来统一管理日志文件，除了syslog以外，内核也需要额外的登录服务来记录内核产生的各项信息，这个专门记录内核信息的日志文件服务就是klogd。总的来说，日志文件所需的服务主要就是syslog和klogd这两者
为了防止日志文件无限量增大，我们可以通过logrotate(日志文件轮替)来自动化处理日志文件容量与更新的问题

所谓logrotate，基本上就是将旧的日志文件更改名称，然后新建一个空的日志文件，如果以来，新的日志文件将重新开始记录，然后只要将旧的日志文件留下一阵子，那就可以达到将日志文件"轮转"。
总结如下:
syslogd:主要登录系统与网络等服务的信息要
klogd:主要登录内核产生的各项信息
logrotate:主要进行日志文件的轮替功能

#syslogd:记录日志文件的服务#

##日志文件内容的一般格式##

一般来说，系统产生的信息经过syslog而记录下来的数据中，每条信息均会记录下面几个重要的数据:
- 事件发生的日期与时间
- 发生此事件的主机名
- 启动该时间的服务名称或函数名称
- 该信息的实际数据内容

##syslog的配置文件:/etc/syslog.conf##

基本上，syslog针对各种服务与信息记录在某些文件的配置文件就是/etc/syslog.conf,这个文件规定了什么服务的什么等级信息以及需要被记录在哪里(设备或文件)这三个东西，设置的语法如下所示:

{% highlight bash %}
服务名称[.=!]信息等级				信息记录的文件名或设备或主机
 #以mail举例:
mail.info			/var/log/maillog_info
 #这一行说明:mail服务产生的大于等于info等级的信息，都记录到/var/log/maillog_info文件中
{% endhighlight %}

**服务名称**
syslog本身有设置一些服务，你可以通过这些服务来存储系统的信息.syslog设置的服务主要有下面这些:

|---------------------+---------------------------------------------------------|
|     服务类型        |  说明                                                   |
|:-------------------:|:--------------------------------------------------------|
|  auth(authpriv)     |  主要与认证有关的机制，例如login,ssh,su等需要账号/密码  |
|  cron               |  就是例行性工作调度cron/at等生成信息日志的地方          |
|  daemon             |  与各个daemon有关的信息                                 |
|  kern               |  就是内核(kernel)产生信息的地方                         |
|  lpr                |  即是打印相关的信息                                     |
|  mail               |  只要与邮件收发有关的信息记录都属于这个                 |
|  news               |  与新闻组服务器有关的东西                               |
|  syslog             |  就是syslogd这个程序本身生成的信息                      |
|  user,uucp,local0~7 |  与Unix like机器本身有关的一些信息                      |
|---------------------+---------------------------------------------------------|

上述表格中的都是syslog自行制定的服务名称，软件开发商可以通过调用上述的服务名称来记录他们的软件。举例来说，sendmail与postfix及dovecot都是与邮件有关的软件，这些软件在设计日志文件记录时，都会主动调用syslogd内的mail服务名称(LOG_MAIL)，所以上述的三个软件(sendmail,postfix,dovecot)产生的信息在syslog看起来，就会是mail类型的服务了。

**信息等级**

|--------+---------------+----------------------------------------------------------------------------------------|
|  等级  |   等级名称    |   说明                                                                                 |
|:------:|:-------------:|:---------------------------------------------------------------------------------------|
|   1    |    info       |  仅是一些基本的信息说明而已                                                            |
|   2    |    notice     |  除了info外还需要注意的一些信息内容                                                    |
|   3    |  warning(warn)|  警示的信息，可能有问题，但是还不至于影响到某个daemon运行的信息；基本上，info,notice,warn这三个信息都是在告知一些基本信息而已，应该还不至于造成一些系统运行困扰          |
|   4    |   err(error)  |  一些重大错误信息，例如配置文件的某些设置造成该服务器无法启动的信息说明，通常通过err的错误告知，应该可以了解到无法启动的问题     |
|   5    |   crit        |  比error还要严重的错误信息，这个crit是临界点(critical)的缩写，这个错误已经很严重了      |
|   6    |   alert       |  警告，已经很有问题的等级，比crit还要严重                                               |
|   7    | emerg(panic)  |  "疼痛"等级，意指系统已经几乎要死机的状态！很严重的错误信息了。通常大概只有硬件出问题导致整个内核无法顺利运行，就会出现这样的等级的信息  |


除了这些等级之外，还有两个特殊的等级，那就是debug(错误检测等级)与none(不需要登录等级)两个，当我们想要做一些错误检测或者是忽略掉某些服务的信息时，就用这两个

另外，还需要注意一下信息等级之前的[.=!]连接符号，它的意思是这样的:
- "."代表后面还要高的等级(含该等级)都被记录下来的意思，例如:mail.info代表只要是mail的信息，而该信息等级高于info(含info)时，就会被记录下来的意思
- ".="代表所需要的等级就是后面接的等级而已，其他的不要
- ".!"代表不等于，即是除了该等级外的其他等级都记录


**信息记录的文件名或设备或主机**
下面是一些常见的放置处:
- 文件的绝对路径:通常就是放在/var/log里面的文件
- 打印机或其他:例如/dec/lp0这个打印设备
- 用户名称:显示给用户
- 远程主机:例如@www.vbird.tsai,当然，要对方主机也能支持才行
- *:代表目前在线的所有人

#日志文件的轮替#

syslog利用的是daemon的方式来启动的，当有需求的时候立刻会被执行的，但是logrotate却是在规定时间到了之后才来进行日志文件的轮替，所以这个logrotate程序当然是挂在cron下面进行的。/etc/cron.daily/logrotate就是记录了每天要进行的日志文件轮替行为

##logrotate的配置文件##

logrotate的参数配置文件:
- /etc/logrotate.conf
- /etc/logrotate.d/

其中，logrotate.conf才是主要的参数文件，至于logrotate.d是一个目录，该目录里面的所有文件都会被主动读入/etc/logrotate.conf当中进行.另外，在/etc/logrotate.d/里面的文件中，如果没有指定一些详细的设置，在以/etc/logrotate.conf这个文件的规定来指定为默认值

logrotate.conf和logrotate.d目录里面的文件都是具有一定格式的，可以进行修改，做成自定义的logrotate操作,具体的格式请参阅P589的例子


#重点回顾#

- 日志文件可以记录一个事件的何时、何地、何人、何事四大信息，故系统有问题时务必查询日志文件 
- 系统的日志文件默认都集中放置到/var/log/目录内，其中又以messages记录的信息最多
- 日志文件记录的主要服务与程序为syslogd,klogd,log
- syslogd的配置文件在/etc/syslog.conf中，内容语法为:服务.等级记载设备或文件
- syslogd本身有提供日志文件服务器的功能，通过修改/etc/sysconfig/syslog内容即可实现
- logrotate程序利用crontab来进行日志文件的轮替功能
- logrotate的配置文件为/etc/logrotate.conf，而额外的设置则可写入/etc/logrotate.d/*内
- logwatch为CentOS5默认提供的一个日志文件分析软件


