---
layout: post
title: 《鸟哥的Linux私房菜:基础篇》学习笔记——14.例行性工作(crontab)
time: 2013-2-14
category: LinuxBase
published: false
---


#什么是例行性工作#

##Linux工作调度的种类:at,cron##

Linux中有两种工作调度的方式:
- 一种是例行的，就是每隔一定的周期要来办的事项
- 一种是突发性的，就是每次做完以后就没有的那一种

Linux中有以下两种命令:
- `at`: `at`是可以处理仅执行一次就结束调度的命令，需要atd服务
- `crontab`:`crontab`这个命令所设置的工作将会循环一直进行下去，可循环的时间为分钟、小时、每周、每月或每年等。`crontab`除了可以使用命令执行外，也可编辑`/etc/crontab`来支持。这个命令需要crond这个服务

##Linux上常见的例行性工作##

- 进行日志文件的轮替(log rotate)
	日志文件会不断增大，我们需要适时地整理日志文件
- 日志文件分析logwatch的任务
- 新建locate的数据库
- whatis数据库的建立
- RPM软件日志文件的新建
- 删除临时文件
- 与网络服务有关的分析行为

#仅执行一次的工作调度#

##atd的启动与at运行的方式##

首先要启动atd这个服务:

{% highlight bash %}
/etc/init.d/atd restart
 #设置开机启动这个服务
chkconfig atd on
{% endhighlight %}

**`at`的运行方式**
我们使用`at`这个命令来生成所要运行的工作，并将这个工作以文本文件的方式写入`/var/spool/at/`目录内，该工作便能等待atd这个服务的取用与执行了。

**`at`的管理**
我们可以利用`/etc/at.allow`和`/etc/at.deny`这两个文件来进行`at`的使用限制！加上这个两个文件后，`at`的工作情况其实是这样的：
1. 先寻找`/etc/at.allow`这个文件，写在这个文件中的用户才能使用`at`，没有在这个文件中的用户则不能使用`at`(即使没有写在`at.deny`中)
2. 如果`/etc/at.allow`不存在，就寻找`/etc/a.deny`这个文件，若写在这个`at.deny`的用户则不能使用`at`，而没有在这个`at.deny`文件中的用户就可以使用`at`了。
3. 如果两个文件都不存在，那么只有root可以使用`at`这个命令

建议在使用`at`命令时，建议最好使用绝对路径来执行命令，比较不会有问题。需要注意的是,**`at`在运行时，会跑到当时执行`at`命令的那个工作目录中去**

`at`命令的执行与终端机环境无关，而所有standard output/standard error output都会传送到执行者的mailbox中去

由于在`at`工作调度的使用上，系统会将该项`at`工作独立出你的bash环境中，直接交给系统的`atd`程序来接管，因此，当你执行了`at`的工作之后就可以立刻脱机了，剩下的工作就完全交给Linux管理即可！所以有长时间的网络工作时，使用`at`可以免除网络断线后的困扰

**`at`工作的管理**

`atq`:查询目前主机上有多少的`at`工作调度
`atrm`:删除`at`工作调度

**`batch`:系统有空时才进行后台任务**

`batch`是利用`at`来进行命令的执行，只是加入了一些控制参数而已，它的特殊地方在于:**它会在CPU工作负载低于0.8的时候，才进行你所执行的工作任务**
工作负载:CPU在单一时间点所负责的工作数量
还需要说明的是，`batch`也是可以使用`atq`和`atrm`来管理

#循环执行的例行性工作调度#

##用户的设置##

用户想要新建循环型工作调度时，使用的是`crontab`这个命令，与`at`相似，我们也可以限制使用`crontab`的用户账号。使用的限制数据有:
- `/etc/cron.allow`
	将可以使`crontab`的账号写入其中，若不在这个文件内的用户则不可使用`crontab`
- `/etc/cron.deny`
	将不可以使用`crontab`的账号写入其中，若未记录到这个文件当中的用户，就可以使用`crontab`

优先级和`at`的相似，一般来说，系统的默认保留一个空的`/etc/cron.deny`

当用户使用`crontab`这个命令来新建工作调度之后，该项工作就会被记录到`/var/spool/cron/`里面去了，而且是以账号来作为判别的。另外，`cron`执行的每一项工作都会被记录到`/var/log/cron`这个日志文件中，所以，如果你的Linux不知道有否被植入木马时，也可以查询一下`/var/log/cron`这个日志文件

当执行`crontab -e`命令后，会进入vi编辑界面，然后以一个工作一行来编辑，每项工作(每行)的格式都是具有六个字段，这六个字段的意义分别如下:

|------------+--------+--------+--------+--------+------+--------|
|  代表意义  |  分钟  |  小时  |  日期  |  月份  |  周  |  命令  |
|:----------:|:------:|:------:|:------:|:------:|:----:|:------:|
|  数字范围  |  0~59  |  0~23  |  1~31  |  1~12  |  0~7 |  命令  |
|------------+--------+--------+--------+--------+------+--------|
周:周的数字为0或7时，都代表"星期天"的意思

辅助字符:

|------------+------------------------------------------------------------------------------------------------------|
|  特殊字符  |																			代表意义                                                        |
|:----------:|:----------------------------------------------------------------------------------------------------:|
|  *(星号)   |  代表任何时刻都接受的意思。																																					|
|  ,(逗号)   |  代表分隔时段的的意思。举例来说，如果要执行的工作是3:00与6:00时，就会是:`0 3,6 * * * command`        |
|  -(减号)   |  代表一段时间范围内，举例来说，8点到12点之间的每小时的20分钟都进行一项工作:`20 8-12 * * * command`   |
|  /n(斜线)  |  那个n代表数字，即是每隔n单位间隔的意思，例如每五分钟进行一次，则:`*/5 * * * * command`              |
|------------+------------------------------------------------------------------------------------------------------|

需要注意的是,如果只是要删除某个`crontab`的工作项目，那么请使用`crontab -e`来重新编辑即可，如果使用`-r`的参数，是会将所有的`crontab`数据内容都删掉的，千万注意了！

##系统的配置文件:`/etc/crontab`##

这个`crontab -e`是针对用户的`cron`来设计的，如果是系统的例行性任务时，只需要编辑`/etc/crontab`这个文件就可以了。需要注意的是，`crontab -e`这个crontab其实是`/usr/bin/crontab`这个可执行文件，但是`/etc/crontab`可是一个"纯文本文件"，你可以以root的身份编辑这个文件

基本上，cron这个服务最低检测限制是"分钟",所以cron会每分钟去读取一次`/etc/cronable`与`/var/spool/cron/`里面的数据内容，因此，只要编辑完`/etc/crontab`这个文件，并且将它保存之后，那么cron的设置就自动会来执行了。

`/etc/crontab`文件中的内容如下所示:

|------+-----+-----+-----+-----+--------+-------------------------------|
|  分  |  时 |  日 |  月 |  周 |  执行者|  命令串 											|
|:----:|:---:|:---:|:---:|:---:|:------:|:-----------------------------:|
|  01  |  *  |  *  |  *  |  *  |  root  |  run-parts  /etc/cron.hourly  |
|------+-----+-----+-----+-----+--------+-------------------------------|

`run-parts`:将后面接的"目录"内的所有文件找出来执行

由于CentOS提供的`run-parts`这个script的辅助，因此`/etc/crontab`这个文件里面支持两种执行命令的方式，一种是直接执行命令，一种则是以目录来规划:

- 命令类型:`01 * * * * flyaway mail -s "testing" kiki < /home/flyaway/test.txt`
- 目录规划:`*/5 * * * * root run-parts /root/runcron`

#可唤醒停机期间的工作任务#

##什么是anacron##

anacron并不是用来替代crontab的，anacron并不能指定何时执行某项任务，而是以天为单位或者是在开机后立刻进行anacron的操作，它会去检测停机期间应该进行但并没有进行的crontab任务，并将该任务执行一遍，然后anacron就会自动停止了。

